---

- hosts: all
  remote_user: root
  become: True
  pre_tasks:

    - name: Install Ubuntu Cloud archive keyring (Debian)
      when: ansible_os_family == 'Debian'
      apt:
        name: ubuntu-cloud-keyring
        state: present

    - name: Enable OpenStack (Debian)
      when: ansible_os_family == 'Debian'
      apt_repository:
        repo: 'deb http://ubuntu-cloud.archive.canonical.com/ubuntu trusty-updates/mitaka main'
        state: present
        update_cache: yes

    - name: Enable OpenStack (RedHat)
      when: ansible_os_family == 'RedHat'
      yum:
        name: "{{ item }}"
        state: present
        update_cache: yes
      with_items:
        - centos-release-openstack-mitaka
        - policycoreutils-python

    # Workaround for selinux errors when using sqlite DB
    - name: Set permissive SElinux for httpd domain
      command: semanage permissive -a httpd_t
      when: ansible_os_family == "RedHat" and (ansible_selinux.mode is defined) and (ansible_selinux.mode == "enforcing")

  roles:

    - role: rabbitmq
      rabbitmq_tcp_address: 0.0.0.0
      rabbitmq_users:
        - vhost   : /
          user    : 'openstack'
          password: '0p3nst4ck'

    - role: openstack-nova-compute
      nova_my_ip: 'localhost'
      vncserver_proxyclient_address: 'localhost'
      vncserver_proxy_address: 'localhost'
      novncproxy_base_url: 'http://localhost:6080/vnc_auto.html'
      nova_virt_type: qemu
      keystone_hostname: localhost
      keystone_admin_password: 'fnordity'
      glance_hostname: localhost
      glance_protocol: http
      rabbit_hostname: localhost
      rabbit_username: 'openstack'
      rabbit_password: '0p3nst4ck'
